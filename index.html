<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>firep</title>
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css" crossorigin="anonymous">
  <style type="text/css">
    pre, .pure-g pre, .pure-g [class*=pure-u] pre {
      font-family: monospace;
    }

    #firep {
      position: relative;
      display: flex;
      flex: 1;
      width: 100%;
    }
    #firep input {
      z-index: 2;
      background-color: transparent;
      width: 100%;
    }
    #firep #highlight {
      z-index: 1;
      flex: 1;
      position: relative;
      display: inline-block;
      white-space: pre;
      line-height: 2;
      border: 1px transparent solid;
      box-sizing: border-box;
      color: transparent;
    }
    #highlight span {
      position: relative;
    }
    #highlight span:before {
      content: ' ';
      position: absolute;
      z-index: 10;
      top: -1px;
      bottom: -1px;
      left: 0;
      right: 0;
      vertical-align: middle;
      display: block;
      border: 1px solid #00a500;
      border-radius: 3px;
      box-sizing: border-box;
      padding: 3px;
      background-color: #DFFEE3;
    }
  </style>
</head>
<body class='pure-g'>
  <div class='pure-u-5-6 pure-u-md-1-3' style="margin: 1em auto;">
    <form class='pure-form' id='firep'>
      <input autocomplete="off" value="lol from:me date>21-07-2017" />
      <div id='highlight'></div>
    </form>

    <pre class='pure-u-1' id='debug'>
      
    </pre>
  </div>
  <script type="text/javascript">
    const opSymbols = {
      ':': 'equal',
      '=': 'equal',
      '>': 'gt',
      '<': 'lt',
      '>=': 'gte',
      '<=': 'lte',
    }

    const parseQuery = function (query) {
      const parts = query.replace(/\s+/, ' ').split(' ').filter(Boolean)

      const analyzedParts = parts.map(p => {
        const parsed = p.match(/^([a-z]+)(:|=|<|>|<=|>=)(.*)$/)

        if (!parsed) {
          return {
            key: 'query',
            op: 'equal',
            value: p,
          }
        }

        const [_, key, opSymbol, value] = parsed

        const startIndex = query.indexOf(p)

        return {
          key,
          op: opSymbols[opSymbol],
          value,
          startIndex,
          endIndex: startIndex + p.length,
          raw: p
        }
      })

      return {
        filters: analyzedParts,
      }
    }

    function updateDebug(input) {
      document.getElementById('debug').innerText = JSON.stringify(
        parseQuery(input.value), null, "  "
      )
    }

    function updateHighlight(input, parsedQuery) {
      const ih = parsedQuery.filters.reduce(
        (acc, f, i) => {
          if (!f.raw) { return acc }
          return {
            cursor: f.endIndex,
            result: (
              acc.result
              + input.value.slice(acc.cursor, f.startIndex)
              + '<span>' + f.raw + '</span>'
            ),
          }
        },
        {cursor: 0, result: ''}
      ).result

      document.getElementById('highlight').innerHTML = ih
      document.getElementById('highlight').style.width = input.clientWidth + 'px'
      document.getElementById('highlight').style.marginLeft = -input.clientWidth + 7 + 'px'
    }

    function redraw(input) {
      const parsedQuery = parseQuery(input.value)
      updateDebug(input)
      updateHighlight(input, parsedQuery)
    }

    document.getElementById('firep').addEventListener('input', event => {
      redraw(event.target)
    })

    redraw(document.getElementById('firep').querySelector('input'))
    // ¯\_(ツ)_/¯ 
    redraw(document.getElementById('firep').querySelector('input'))
  </script>
</body>
</html>
