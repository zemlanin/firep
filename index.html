<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>firep</title>

  <style type="text/css">
    #debug {
      width: 100%;
    }

    body, input {
      font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
    }

    #firep {
      position: relative;
      display: flex;
      flex: 1;
      width: 100%;
      border: 1px lightgray solid;
      border-radius: 3px;
      padding: 5px;
    }
    #firep input {
      z-index: 2;
      background-color: transparent;
      width: 100%;
      border: none;
      outline: none;
      padding: 0;
      margin: 0;
      font-size: 16px;
    }
    #firep #highlight {
      z-index: 1;
      flex: 1;
      position: relative;
      display: inline-block;
      white-space: pre;
      line-height: 2;
      box-sizing: border-box;
      color: transparent;

      -debug-z-index: 10;
      -debug-color: red;
    }
    #highlight span {
      position: relative;
    }
    #highlight span:before {
      content: ' ';
      position: absolute;
      z-index: 10;
      top: -1px;
      bottom: -1px;
      left: -1px;
      right: -1px;
      vertical-align: middle;
      display: block;
      border: 1px solid #00a500;
      border-radius: 3px;
      box-sizing: border-box;
      padding: 3px;
      background-color: #DFFEE3;
      -debug-background-color: transparent;
    }

    #wrapper {
      width: 40%;
      margin: 1em auto;
    }

    @media (max-width: 600px) {
      #wrapper {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <div id='wrapper'>
    <form id='firep'>
      <input autocomplete="off" value="lol from:me date>21-07-2017" />
      <div id='highlight'></div>
    </form>

    <pre id='debug'></pre>
  </div>
  <script type="text/javascript">
    const opSymbols = {
      ':': 'equal',
      '=': 'equal',
      '>': 'gt',
      '<': 'lt',
      '>=': 'gte',
      '<=': 'lte',
    }

    const parseQuery = function (query) {
      const parts = query.replace(/\s+/, ' ').split(' ').filter(Boolean)

      const condRegex = /(^|\s*|)([a-z_]+)(:|=|<|>|<=|>=)(\S*)(\s*)/g

      const analyzedParts = []
      let condCursor, lastIndex = 0

      while ((condCursor = condRegex.exec(query)) !== null) {
        const [_, _spaceStart, key, opSymbol, value, _spaceEnd] = condCursor

        if (lastIndex != condCursor.index) {
          analyzedParts.push({
            key: 'query',
            op: 'equal',
            value: query.slice(lastIndex, condCursor.index),
          })
        }

        lastIndex = condRegex.lastIndex
        const raw = key + opSymbol + value
        const startIndex = condCursor.index + _spaceStart.length

        analyzedParts.push({
          key,
          op: opSymbols[opSymbol],
          value,
          startIndex,
          endIndex: startIndex + raw.length,
          raw: raw,
        })
      }

      if (lastIndex != query.length) {
        analyzedParts.push({
          key: 'query',
          op: 'equal',
          value: query.slice(lastIndex, query.length),
        })
      }

      return {
        filters: analyzedParts,
      }
    }

    function updateDebug(input) {
      document.getElementById('debug').innerText = JSON.stringify(
        parseQuery(input.value), null, "  "
      )
    }

    function getTextWidth(text, font) {
      font = font || '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"'
      const canvas = getTextWidth.canvas ||
        (getTextWidth.canvas = document.createElement("canvas"))
      const context = canvas.getContext("2d")
      context.font = font
      return context.measureText(text).width
  }

    function updateHighlight(input, parsedQuery) {
      if (getTextWidth(input.value) > input.clientWidth) {
        document.getElementById('highlight').innerHTML = ' '
        return
      }

      const ih = parsedQuery.filters.reduce(
        (acc, f, i) => {
          if (!f.raw) { return acc }
          return {
            cursor: f.endIndex,
            result: (
              acc.result
              + input.value.slice(acc.cursor, f.startIndex)
              + '<span>' + f.raw + '</span>'
            ),
          }
        },
        {cursor: 0, result: ''}
      ).result

      const inputWidth = input.clientWidth

      document.getElementById('highlight').innerHTML = ih
      document.getElementById('highlight').style.width = inputWidth + 'px'
      document.getElementById('highlight').style.marginLeft = -inputWidth + 'px'
    }

    function redraw(input) {
      const parsedQuery = parseQuery(input.value)
      updateDebug(input)
      updateHighlight(input, parsedQuery)
    }

    ;(function() {
      const throttle = function (type, name, obj) {
        let running = false;
        obj.addEventListener(type, function() {
          if (running) { return; }
          running = true;
          requestAnimationFrame(function() {
            obj.dispatchEvent(new CustomEvent(name));
            running = false;
          });
        });
      };

      throttle("resize", "optimizedResize", window);
    })();

    redraw(document.getElementById('firep').querySelector('input'))

    window.addEventListener("optimizedResize", function () {
      redraw(document.getElementById('firep').querySelector('input'))
    });

    document.getElementById('firep').addEventListener('input', event => {
      redraw(event.target)
    })
  </script>
</body>
</html>
